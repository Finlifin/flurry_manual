<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>资源管理与 Drop - Flurry语言手册</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../../favicon.svg">
        <link rel="shortcut icon" href="../../favicon.png">
        <link rel="stylesheet" href="../../css/variables.css">
        <link rel="stylesheet" href="../../css/general.css">
        <link rel="stylesheet" href="../../css/chrome.css">
        <link rel="stylesheet" href="../../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="../../highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="../../tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "../../";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../../toc.js"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Flurry语言手册</h1>

                    <div class="right-buttons">
                        <a href="../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h2 id="资源管理与-drop-精化"><a class="header" href="#资源管理与-drop-精化">资源管理与 Drop 精化</a></h2>
<p>Flurry 的所有权系统不仅仅是为了防止数据竞争或非法访问，其核心目标之一是实现<strong>可靠且自动的资源管理</strong>。无论是堆上分配的内存、打开的文件句柄、网络套接字还是其他系统资源，都需要在不再使用时被精确地释放，以避免泄漏。Flurry 通过类似于 C++ RAII (Resource Acquisition Is Initialization) 和 Rust <code>Drop</code> Trait 的机制，结合编译器的<strong>Drop 精化 (Drop Elaboration)</strong> 来自动化这个过程。</p>
<h3 id="raii-资源生命周期绑定到对象生命周期"><a class="header" href="#raii-资源生命周期绑定到对象生命周期">RAII: 资源生命周期绑定到对象生命周期</a></h3>
<p>Flurry 遵循 RAII 的核心思想：资源的生命周期与拥有该资源的对象（值）的生命周期相绑定。</p>
<ol>
<li><strong>获取即初始化</strong>: 当创建一个需要管理资源的对象时（例如，调用 <code>File.open(...)</code> 或 <code>Vec.new()</code>），该对象在其内部获取并管理所需的资源（文件句柄、堆内存）。</li>
<li><strong>析构即释放</strong>: 当该对象<strong>离开其作用域</strong>或者其<strong>所有权结束</strong>时，它所拥有的资源必须被释放。</li>
</ol>
<h3 id="drop-操作与-drop-trait-假设"><a class="header" href="#drop-操作与-drop-trait-假设"><code>drop</code> 操作与 <code>Drop</code> Trait (假设)</a></h3>
<p>为了实现资源的自动释放，Flurry 预计会提供一个类似 Rust <code>Drop</code> Trait 的机制（具体名称和形式待定，我们暂且称之为 <code>Drop</code>）：</p>
<ul>
<li><strong><code>Drop</code> Trait</strong>: 需要自定义资源清理逻辑的类型可以实现 <code>Drop</code> Trait。这个 Trait 通常包含一个 <code>drop</code> 方法。
<pre><code class="language-flurry">-- 概念性示例
trait Drop {
    fn drop(*self); -- drop 方法接收一个可变指针
}

impl Drop for MyFileWrapper {
    fn drop(*self) {
        -- 关闭文件句柄，释放相关资源
        unsafe { close_file_handle(self.handle) }
        println("MyFileWrapper dropped!");
    }
}
</code></pre>
</li>
<li><strong>默认行为</strong>: 对于没有实现 <code>Drop</code> Trait 的类型（例如只包含 <code>Copy</code> 类型字段的结构体），其“drop”操作通常是无操作 (no-op)，或者仅仅是递归地 drop 其包含的字段（如果字段本身实现了 <code>Drop</code>）。</li>
</ul>
<h3 id="编译器的-drop-精化"><a class="header" href="#编译器的-drop-精化">编译器的 Drop 精化</a></h3>
<p>开发者通常<strong>不需要手动调用</strong> <code>drop</code> 方法。Flurry 编译器的关键职责之一就是执行 <strong>Drop 精化</strong>：在编译期间，静态地分析代码，并在每个值的所有权结束时<strong>自动插入对 <code>drop</code> 的调用</strong>。</p>
<p><strong>编译器插入 <code>drop</code> 的时机:</strong></p>
<p>编译器通过<strong>所有权</strong>和<strong>生命周期</strong>分析来确定何时插入 <code>drop</code>：</p>
<ol>
<li>
<p><strong>离开作用域</strong>: 当一个拥有资源的值（非 <code>Copy</code> 类型）绑定的变量离开其声明的作用域时，并且其所有权没有被移动走，编译器会在此作用域结束处插入 <code>drop</code> 调用。</p>
<pre><code class="language-flurry">{
    let file = File.open("temp.txt")!; -- file 拥有文件句柄
    -- ... 使用 file ...
} -- file 离开作用域，编译器在此处隐式插入 drop(file)
</code></pre>
</li>
<li>
<p><strong>所有权转移后</strong>: 如果一个值的所有权被移动（例如，赋值给新变量、作为函数参数传递、从函数返回），则<strong>原来的绑定</strong>就不再拥有该值，编译器<strong>不会</strong>在其离开作用域时为其插入 <code>drop</code>。<code>drop</code> 的责任随着所有权一起转移给了新的所有者。</p>
<pre><code class="language-flurry">fn process_file(f: File) {
    -- ... f 在函数内部被使用 ...
} -- f 在函数结束时离开作用域，编译器在此处插入 drop(f)

let my_file = File.open("data.log")!;
process_file(my_file); -- 所有权移动到 f
-- my_file 离开作用域，但所有权已转移，编译器 *不* 在此处为 my_file 插入 drop
</code></pre>
</li>
<li>
<p><strong>控制流</strong>: 编译器需要分析 <code>if</code>/<code>else</code>、<code>match</code>、循环等控制流。如果一个值在某个代码分支中被移动或消耗，而在另一个分支中没有，编译器需要确保在后者对应的路径结束时插入 <code>drop</code>。</p>
<pre><code class="language-flurry">fn example(use_it: bool) {
    let data = allocate_resource();
    if use_it {
        consume_resource(data); -- data 所有权在这里被转移
    } else {
        -- data 在这个分支没有被消耗
        println("Resource not consumed.");
    }
    -- 编译器需要分析：
    -- 如果 use_it 为 true，data 已被移动，这里什么都不做。
    -- 如果 use_it 为 false，data 仍然有效且即将离开作用域，
    -- 编译器会在此处（概念上是 else 分支结束和函数返回之间）插入 drop(data)。
}
</code></pre>
<p>这与您在问题描述中给出的 <code>main</code> 和 <code>consumes</code> 函数示例的行为一致。</p>
</li>
</ol>
<p><strong>优势:</strong></p>
<ul>
<li><strong>自动化</strong>: 开发者无需手动管理资源释放，减少了忘记释放资源导致泄漏的可能性。</li>
<li><strong>及时性</strong>: 资源在不再需要时（所有权结束时）立即被释放，而不是等待垃圾回收器运行，这对于需要精确控制生命周期的资源（如文件锁、网络连接）非常重要。</li>
<li><strong>确定性</strong>: 资源释放的时机是确定的（由作用域和所有权规则决定），便于推理程序的行为。</li>
<li><strong>异常安全 (潜力)</strong>: 如果与错误处理（例如 <code>!</code>）或效应系统（如代数效应）结合，可以设计出即使在发生错误或非本地控制流转移时也能保证资源被正确释放的模式（例如，通过 unwind 或者特定的恢复机制调用 <code>drop</code>）。</li>
</ul>
<p><strong>总结:</strong></p>
<p>Flurry 通过结合 RAII 原则、类似 <code>Drop</code> Trait 的机制以及编译器的<strong>Drop 精化</strong>，实现了自动化、确定性的资源管理。编译器静态地跟踪值的所有权和生命周期，在所有权结束时自动插入资源释放逻辑 (<code>drop</code>)。这使得开发者能够专注于业务逻辑，同时获得强大的内存安全和资源安全保证，避免了手动资源管理带来的许多常见错误。理解 Drop 精化是理解 Flurry 如何确保资源安全的关键。</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../core/ownership/references.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../../core/ownership/reachability_effects.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../core/ownership/references.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../../core/ownership/reachability_effects.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../../elasticlunr.min.js"></script>
        <script src="../../mark.min.js"></script>
        <script src="../../searcher.js"></script>

        <script src="../../clipboard.min.js"></script>
        <script src="../../highlight.js"></script>
        <script src="../../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
